<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MNie | Testing GraphQL queries with FsCheck library</title>
  <meta name="description" content="GraphQL essentially allows users to define queries from a front-end to gather concrete data. So as it looks it is completely different than a standard REST endpoint. GraphQL differs queries which only gather data from those which also mutates them. In this article, I want to concentrate on queries which only gather some data and how to test them via FsCheck and F#.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Testing GraphQL queries with FsCheck library">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://mnie.me/graphqltesting">
  <meta property="og:description" content="GraphQL essentially allows users to define queries from a front-end to gather concrete data. So as it looks it is completely different than a standard REST endpoint. GraphQL differs queries which only gather data from those which also mutates them. In this article, I want to concentrate on queries which only gather some data and how to test them via FsCheck and F#.">
  <meta property="og:site_name" content="MNie">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://mnie.me/graphqltesting">
  <meta name="twitter:title" content="Testing GraphQL queries with FsCheck library">
  <meta name="twitter:description" content="GraphQL essentially allows users to define queries from a front-end to gather concrete data. So as it looks it is completely different than a standard REST endpoint. GraphQL differs queries which only gather data from those which also mutates them. In this article, I want to concentrate on queries which only gather some data and how to test them via FsCheck and F#.">

  
    
      <meta property="og:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
      <meta name="twitter:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
    
  

  <link href="http://mnie.me/feed.xml" type="application/rss+xml" rel="alternate" title="MNie Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-8d94e1b2ced7d843d882416da48ad6b7a0386071412905b6048dbe8205e32559.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-03c296a876e33d932966817b36fde1212bdb044fb0585145cde98ac98da59715.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-52a5e7e150abd939a150d09a93ec31ffd219b9e01c09465a899f36f3654beef1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="MNie">MNie</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/mnie8" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/mnie" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://stackoverflow.com/users/2947860" rel="noreferrer noopener" target="_blank" title="Stack Overflow">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-stackoverflow">
  <use href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow" xlink:href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/michał-niegrzybowski" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:michal.niegrzybowski@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>Testing GraphQL queries with FsCheck library</h1>
            <p>GraphQL essentially allows users to define queries from a front-end to gather concrete data. So as it looks it is completely different than a standard REST endpoint. GraphQL differs queries which only gather data from those which also mutates them. In this article, I want to concentrate on queries which only gather some data and how to test them via FsCheck and F#.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    May 7, 2018
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      11 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/fsharp" title="See all posts with tag 'F#'">F#</a>
    
      
      <a href="/tag/graphql" title="See all posts with tag 'GraphQL'">GraphQL</a>
    
      
      <a href="/tag/cleancode" title="See all posts with tag 'Clean Code'">Clean Code</a>
    
      
      <a href="/tag/tests" title="See all posts with tag 'Tests'">Tests</a>
    
      
      <a href="/tag/tdd" title="See all posts with tag 'TDD'">TDD</a>
    
      
      <a href="/tag/automatedtests" title="See all posts with tag 'Automated Tests'">Automated Tests</a>
    
      
      <a href="/tag/patterns" title="See all posts with tag 'Patterns'">Patterns</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Hi,</p>

<p>some time ago I had a pleasure to join a project which uses a <a href="https://graphql.org/">GraphQL library</a>. GraphQL essentially allows users to define queries from a front-end to gather concrete data. So as it looks it is completely different than a standard REST endpoint. GraphQL differs queries which only gather data from those which also mutates them. In this article, I want to concentrate on queries which only gather some data and how to test them.</p>

<p>I don’t want to go deep into GraphQL details and how to create some GraphQL query. I assume that we have a query in which we could ask about car details. Model for beforehand said <code class="highlighter-rouge">Car</code> looks like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Engine</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Indicator</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Power</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Displacement</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Car</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Model</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Engine</span> <span class="n">Engine</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>GraphType:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">EngineGraphType</span> <span class="p">:</span> <span class="n">ObjectGraphType</span><span class="p">&lt;</span><span class="n">Engine</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">EngineGraphType</span><span class="p">(</span><span class="n">IEngineProvider</span> <span class="n">engineProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Engine"</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">NonNullGraphType</span><span class="p">&lt;</span><span class="n">StringGraphType</span><span class="p">&gt;&gt;(</span>
            <span class="s">"indicator"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Indicator</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">NonNullGraphType</span><span class="p">&lt;</span><span class="n">IntGraphType</span><span class="p">&gt;&gt;(</span>
            <span class="s">"power"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Power</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">NonNullGraphType</span><span class="p">&lt;</span><span class="n">IntGraphType</span><span class="p">&gt;&gt;(</span>
            <span class="s">"displacement"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Displacement</span>
        <span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CarGraphType</span> <span class="p">:</span> <span class="n">ObjectGraphType</span><span class="p">&lt;</span><span class="n">Car</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CarGraphType</span><span class="p">(</span><span class="n">IEngineProvider</span> <span class="n">engineProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Car"</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">NonNullGraphType</span><span class="p">&lt;</span><span class="n">StringGraphType</span><span class="p">&gt;&gt;(</span>
            <span class="s">"name"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Name</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">StringGraphType</span><span class="p">&gt;(</span>
            <span class="s">"model"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Model</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Field</span><span class="p">&lt;</span><span class="n">EngineGraphType</span><span class="p">&gt;(</span>
            <span class="s">"engine"</span><span class="p">,</span>
            <span class="n">resolve</span><span class="p">:</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">engineProvider</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">Source</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>And finally a query:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CarQuery</span> <span class="p">:</span> <span class="n">RootQueryField</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICarResolver</span> <span class="n">_carResolver</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CarQuery</span><span class="p">(</span><span class="n">ICarResolver</span> <span class="n">carResolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_carResolver</span> <span class="p">=</span> <span class="n">carResolver</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"car"</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">QueryArguments</span><span class="p">(</span>
            <span class="k">new</span> <span class="n">QueryArgument</span><span class="p">&lt;</span><span class="n">NonNullGraphType</span><span class="p">&lt;</span><span class="n">StringGraphType</span><span class="p">&gt;&gt;</span>
            <span class="p">{</span>
                <span class="n">Name</span> <span class="p">=</span> <span class="s">"name"</span>
            <span class="p">}</span>
        <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Resolver</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FuncFieldResolver</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">Car</span><span class="p">&gt;&gt;(</span><span class="k">this</span><span class="p">.</span><span class="n">Resolve</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CarGraphType</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Car</span><span class="p">&gt;</span> <span class="nf">Resolve</span><span class="p">(</span><span class="n">ResolveFieldContext</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">param</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">ToObject</span><span class="p">&lt;</span><span class="n">ConcreteArguments</span><span class="p">&gt;();</span>
        <span class="k">return</span> <span class="n">_carResolver</span>
            <span class="p">.</span><span class="nf">ResolveAsync</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Thanks to that we could ask for a data a GraphQL endpoint like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">car</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">name of a car</span><span class="dl">"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">name</span>
    <span class="nx">model</span>
    <span class="nx">engine</span> <span class="p">{</span>
        <span class="nx">indicator</span>
        <span class="nx">power</span>
        <span class="nx">displacement</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Of course, as I said before we don’t need to specify all fields in an expected result. The query could be highly modifiable, so I thought it would be great idea to write some FsCheck tests, which would scan a GraphQL graph with a query and based on them generates sample queries. Thanks to which I could check a couple of properties. One of them would be to check if there are not any errors sections in GraphQL response, the second one would be to check if all responses end with a 200 HTTP Status Code. Thanks to the above I could be one hundred percent sure that all queries would work fine (maybe not from a business perspective :)), especially that those tests would be included in a CI pipeline as a part of integration tests.</p>

<p>To use a FsCheck library I have to write a generator for an input data. As an input data, I assume a serialized query. The project is written in a C#, so I used this language to write a generator.</p>

<p>Starting from a generic generator signature I assume that every query has to implement a method to collect data needed to create queries with arguments on their own. Also, every generator would know which class represents those arguments. So the signature of a generator looks as follows.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">QueryArb</span><span class="p">&lt;</span><span class="n">TGraphQuery</span><span class="p">,</span> <span class="n">TArguments</span><span class="p">&gt;</span></code></pre></figure>

<p>As we see <code class="highlighter-rouge">TGraphQuery</code> is responsible for a query type which we want to be our <code class="highlighter-rouge">subject under test</code> while <code class="highlighter-rouge">TArguments</code> stands for an accepted arguments by query.
Going to an implementation of a generator I would present the whole code and then describe it line by line.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="n">Arbitrary</span><span class="p">&lt;</span><span class="n">QueryTest</span><span class="p">&gt;</span> <span class="nf">BuildArb</span><span class="p">(</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="n">Gen</span><span class="p">&lt;</span><span class="n">TArguments</span><span class="p">&gt;&gt;</span> <span class="n">fetchArgsFunc</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">ContainerFactory</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">container</span>
        <span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">RootQueryField</span><span class="p">&gt;&gt;()</span>
        <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">x</span> <span class="k">as</span> <span class="n">TGraphQuery</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">queryType</span> <span class="p">=</span> <span class="nf">ResolveQueryType</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">Type</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">graphType</span> <span class="p">=</span> <span class="p">(</span><span class="n">IObjectGraphType</span><span class="p">)</span><span class="n">container</span>
        <span class="p">.</span><span class="nf">Resolve</span><span class="p">(</span><span class="n">queryType</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">hasArguments</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">query</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="nf">Any</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">gen</span> <span class="p">=</span> <span class="n">hasArguments</span>
        <span class="p">?</span> <span class="nf">GenWithArguments</span><span class="p">(</span><span class="n">fetchArgsFunc</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">graphType</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
        <span class="p">:</span> <span class="nf">GenWithoutArguments</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">graphType</span><span class="p">,</span> <span class="n">container</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">gen</span><span class="p">.</span><span class="nf">ToArbitrary</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>We start by building a container for all dependencies. Next, we gather query of concrete <code class="highlighter-rouge">IGraphType</code> type (our generic type) from all registered <code class="highlighter-rouge">RootQueryFields</code>, we have to remember that all queries are registered as <code class="highlighter-rouge">RootQueryFields</code> so if we would try to gather concrete <code class="highlighter-rouge">IGraphType</code> from an AutoFac container we would get an exception. Then we get information about the graph and its instance from a container cause we need an information about defined GraphQL fields for that query which are defined in a constructor. Also, we need to retain that those types could be also a generic type like <code class="highlighter-rouge">ListGraphType&lt;OurCustomGraphType&gt;</code> so we want to gather a generic argument. We could do that thanks to the below method:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="n">Type</span> <span class="nf">ResolveQueryType</span><span class="p">(</span><span class="n">Type</span> <span class="n">queryType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">@type</span> <span class="p">=</span> <span class="n">queryType</span><span class="p">.</span><span class="n">IsGenericType</span>
        <span class="p">?</span> <span class="n">queryType</span><span class="p">.</span><span class="n">GenericTypeArguments</span><span class="p">.</span><span class="nf">First</span><span class="p">()</span>
        <span class="p">:</span> <span class="n">queryType</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">@type</span><span class="p">.</span><span class="n">IsGenericType</span>
        <span class="p">?</span> <span class="nf">ResolveQueryType</span><span class="p">(</span><span class="n">@type</span><span class="p">)</span>
        <span class="p">:</span> <span class="n">@type</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>As we can see I don’t have here a stop guard cause I suppose (maybe incorrectly) that people don’t create infinite generic types.
Next phase is a check if query accepts some arguments, if yes we want to create a query with them if nope we only need fields for which we could ask. We are going to the implementation of a generator with arguments.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="n">Gen</span><span class="p">&lt;</span><span class="n">QueryTest</span><span class="p">&gt;</span> <span class="nf">GenWithArguments</span><span class="p">(</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="n">Gen</span><span class="p">&lt;</span><span class="n">TArguments</span><span class="p">&gt;&gt;</span> <span class="n">fetchArgsFunc</span><span class="p">,</span>
    <span class="n">RootQueryField</span> <span class="n">query</span><span class="p">,</span>
    <span class="n">IObjectGraphType</span> <span class="n">graphType</span><span class="p">,</span>
    <span class="n">IContainer</span> <span class="n">container</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">argNames</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">fields</span> <span class="p">=</span> <span class="n">graphType</span><span class="p">.</span><span class="n">Fields</span>
        <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">GetFieldRepresentation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>

    <span class="kt">var</span> <span class="n">fieldsSublist</span> <span class="p">=</span> <span class="n">Gen</span><span class="p">.</span><span class="nf">SubListOf</span><span class="p">(</span><span class="n">fields</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="nf">fetchArguments</span><span class="p">(</span><span class="n">argNames</span><span class="p">);</span>

    <span class="k">return</span>
        <span class="k">from</span> <span class="n">selectedFields</span> <span class="k">in</span> <span class="n">fieldsSublist</span>
        <span class="k">from</span> <span class="n">arg</span> <span class="k">in</span> <span class="n">arguments</span>
        <span class="k">where</span> <span class="n">selectedFields</span><span class="p">.</span><span class="nf">Any</span><span class="p">()</span>
        <span class="k">select</span> <span class="nf">BuildQuery</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">selectedFields</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>As we could see we get all arguments, then query name and all fields for which we could ask. Implementation of a <code class="highlighter-rouge">GetFieldRepresentation</code> looks as follows:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetFieldRepresentation</span><span class="p">(</span>
    <span class="n">IFieldType</span> <span class="n">field</span><span class="p">,</span>
    <span class="n">IContainer</span> <span class="n">container</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">deep</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">deep</span> <span class="p">&gt;</span> <span class="m">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">customType</span> <span class="p">=</span> <span class="n">field</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">IsGenericType</span>
        <span class="p">?</span> <span class="n">field</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">GenericTypeArguments</span><span class="p">.</span><span class="nf">First</span><span class="p">()</span>
        <span class="p">:</span> <span class="n">field</span><span class="p">.</span><span class="n">Type</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">container</span><span class="p">.</span><span class="nf">IsRegistered</span><span class="p">(</span><span class="n">customType</span><span class="p">)</span>
        <span class="p">?</span> <span class="nf">GetFieldRepresentation</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">customType</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
        <span class="p">:</span> <span class="n">field</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>It based on gathering field name if the type of this field is a simple GraphlQL type (for example IntGraphType etc. ) if the type is more complex we want to gather all fields of this complex field as long as we reach a max deep of 3.</p>

<p>Going back to the previous method. Based on gathered fields, which are in a form of string list, we create a generator rest on them. Then, we get all arguments for a query based on a function which is passed as an argument. Next, at the end of this function we create our final generator which depends on fields and arguments, we also keep in mind that our query has to contain some fields, so we have to filter out a situation where fields list is empty.
Finally, we build test object thanks to the <code class="highlighter-rouge">BuildQuery</code> function, which looks like this:</p>

<script src="https://gist.github.com/MNie/d8e8e1e5e3825766050c6f956eb35d53.js"></script>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">internal</span> <span class="k">class</span> <span class="nc">QueryTest</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">Query</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">QueryTest</span><span class="p">(</span><span class="kt">string</span> <span class="n">query</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="n">Query</span> <span class="p">=</span> <span class="n">query</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>As it seems it isn’t a rocket science, only a combination of a graphQL query.</p>

<p>Implementation of a method responsible for the creation of a query without arguments looks very similar to this with arguments:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="n">Gen</span><span class="p">&lt;</span><span class="n">CarTest</span><span class="p">&gt;</span> <span class="nf">GenWithoutArguments</span><span class="p">(</span>
    <span class="n">RootQueryField</span> <span class="n">query</span><span class="p">,</span>
    <span class="n">IObjectGraphType</span> <span class="n">graphType</span><span class="p">,</span>
    <span class="n">IContainer</span> <span class="n">container</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">fields</span> <span class="p">=</span> <span class="n">graphType</span><span class="p">.</span><span class="n">Fields</span>
        <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">GetFieldRepresentation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>

    <span class="kt">var</span> <span class="n">fieldsSublist</span> <span class="p">=</span> <span class="n">Gen</span><span class="p">.</span><span class="nf">SubListOf</span><span class="p">(</span><span class="n">fields</span><span class="p">);</span>

    <span class="k">return</span>
        <span class="k">from</span> <span class="n">selectedFields</span> <span class="k">in</span> <span class="n">fieldsSublist</span>
        <span class="k">where</span> <span class="n">selectedFields</span><span class="p">.</span><span class="nf">Any</span><span class="p">()</span>
        <span class="k">select</span> <span class="nf">BuildQuery</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">EmptyArguments</span><span class="p">,</span> <span class="n">selectedFields</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The question is how concrete generator for cars would look like?</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">internal</span> <span class="k">class</span> <span class="nc">CarArguments</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CarArguments</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">CarArb</span> <span class="p">:</span> <span class="n">QueryArb</span><span class="p">&lt;</span><span class="n">CarQuery</span><span class="p">,</span> <span class="n">CarArguments</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Arbitrary</span><span class="p">&lt;</span><span class="n">QueryTest</span><span class="p">&gt;</span> <span class="nf">Build</span><span class="p">()</span> <span class="p">=&gt;</span>
        <span class="nf">BuildArb</span><span class="p">(</span><span class="n">FetchArgs</span><span class="p">);</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">Gen</span><span class="p">&lt;</span><span class="n">CarArguments</span><span class="p">&gt;</span> <span class="nf">FetchArgs</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">argNames</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="p">[]{</span><span class="m">23</span><span class="p">,</span> <span class="m">45</span><span class="p">};</span>
        <span class="k">return</span> <span class="k">from</span> <span class="n">single</span> <span class="k">in</span> <span class="n">Gen</span><span class="p">.</span><span class="nf">Elements</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">select</span> <span class="k">new</span> <span class="nf">CarArguments</span><span class="p">(</span><span class="n">single</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As we could see generator for a concrete query is very simple and readable, tests look like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">//_client is a HttpClient from a Microsoft.AspNetCore.TestHost.TestServer</span>
<span class="p">[</span><span class="n">FsCheck</span><span class="p">.</span><span class="n">NUnit</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">Arbitrary</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CarArb</span><span class="p">)</span> <span class="p">},</span> <span class="n">MaxTest</span> <span class="p">=</span> <span class="m">100</span><span class="p">)]</span>
<span class="k">public</span> <span class="n">Property</span> <span class="nf">Query_returns200</span><span class="p">(</span><span class="n">QueryTest</span> <span class="n">query</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">$"?query=</span><span class="p">{</span><span class="n">query</span><span class="p">}</span><span class="s">"</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">().</span><span class="nf">GetResult</span><span class="p">();</span>
    <span class="c1">//cause await seems to be not working fine with FsCheck 2.9</span>
    <span class="c1">//(when method is marked as an async)</span>

    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">ToProperty</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">}</span><span class="s"> = 200"</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">FsCheck</span><span class="p">.</span><span class="n">NUnit</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">Arbitrary</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CarArb</span><span class="p">)</span> <span class="p">},</span> <span class="n">MaxTest</span> <span class="p">=</span> <span class="m">100</span><span class="p">)]</span>
<span class="k">public</span> <span class="n">Property</span> <span class="nf">Query_HaveNoErrorsSection</span><span class="p">(</span><span class="n">QueryTest</span> <span class="n">query</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">$"?query=</span><span class="p">{</span><span class="n">query</span><span class="p">}</span><span class="s">"</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">().</span><span class="nf">GetResult</span><span class="p">();</span>
    <span class="c1">//cause await seems to be not working fine with FsCheck 2.10</span>
    <span class="c1">//(when method is marked as an async)</span>
    <span class="kt">var</span> <span class="n">content</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">().</span><span class="nf">GetResult</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">ErrorSections</span><span class="p">(</span><span class="n">parsedContent</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">IsEmpty</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">ToProperty</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">result</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"\r\n"</span><span class="p">)}</span><span class="s"> = empty array"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ErrorSections</span><span class="p">(</span><span class="kt">string</span> <span class="n">content</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">jObj</span> <span class="p">=</span> <span class="n">JObject</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">jObj</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"errors"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>To sum up, we could create very easily a FsCheck generator so that a GraphQL query would be tested almost in 100% in case of some lacks in implementation. It helps us in delivering a new version of our application which couldn’t be spotted while writing some single unit tests or manual tests.</p>

<p>Thanks for reading!</p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Testing+GraphQL+queries+with+FsCheck+library%20-%20http://mnie.me/graphqltesting%20by%20@mnie8" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://mnie.me/graphqltesting" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer scrollappear">
  <p>
    2020
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-81299349-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-81299349-1');
  </script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
