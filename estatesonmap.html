<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MNie | Visualization of estates on a map with Fable</title>
  <meta name="description" content="From time to time I look at bailiff auctions. To check if there are some interesting properties for sale. If I want to check where they are located I have to go into details of each auction. I felt it would be great to see all of them on the map, so I could filter them by localization or district.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Visualization of estates on a map with Fable">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://mnie.me/estatesonmap">
  <meta property="og:description" content="From time to time I look at bailiff auctions. To check if there are some interesting properties for sale. If I want to check where they are located I have to go into details of each auction. I felt it would be great to see all of them on the map, so I could filter them by localization or district.">
  <meta property="og:site_name" content="MNie">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://mnie.me/estatesonmap">
  <meta name="twitter:title" content="Visualization of estates on a map with Fable">
  <meta name="twitter:description" content="From time to time I look at bailiff auctions. To check if there are some interesting properties for sale. If I want to check where they are located I have to go into details of each auction. I felt it would be great to see all of them on the map, so I could filter them by localization or district.">

  
    
      <meta property="og:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
      <meta name="twitter:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
    
  

  <link href="http://mnie.me/feed.xml" type="application/rss+xml" rel="alternate" title="MNie Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-8d94e1b2ced7d843d882416da48ad6b7a0386071412905b6048dbe8205e32559.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-03c296a876e33d932966817b36fde1212bdb044fb0585145cde98ac98da59715.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-52a5e7e150abd939a150d09a93ec31ffd219b9e01c09465a899f36f3654beef1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="MNie">MNie</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/mnie8" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/mnie" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://stackoverflow.com/users/2947860" rel="noreferrer noopener" target="_blank" title="Stack Overflow">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-stackoverflow">
  <use href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow" xlink:href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/michał-niegrzybowski" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:michal.niegrzybowski@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>Visualization of estates on a map with Fable</h1>
            <p>From time to time I look at bailiff auctions. To check if there are some interesting properties for sale. If I want to check where they are located I have to go into details of each auction. I felt it would be great to see all of them on the map, so I could filter them by localization or district.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    January 8, 2020
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      25 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/fsharp" title="See all posts with tag 'F#'">F#</a>
    
      
      <a href="/tag/fable" title="See all posts with tag 'Fable'">Fable</a>
    
      
      <a href="/tag/javascript" title="See all posts with tag 'JavaScript'">JavaScript</a>
    
      
      <a href="/tag/patterns" title="See all posts with tag 'Patterns'">Patterns</a>
    
      
      <a href="/tag/microservices" title="See all posts with tag 'Microservices'">Microservices</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Hi,</p>

<p>from time to time I look at bailiff auctions. To check if there are some interesting properties for sale. If I want to check where they are located I have to go into details of each auction. I felt it would be great to see all of them on the map, so I could filter them by localization or district.</p>

<p>I decided to write an application that would gather information about auctions in FABLE. Based on that information I want to show markers on a map with a prize, date of auction and a link to full details of an auction inside of it.</p>

<p>I started from creating a blank project. (Thanks to <a href="https://github.com/SAFE-Stack/SAFE-template">SAFE Template</a>):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dotnet new <span class="nt">-i</span> Bailif –server Saturn –communication remoting –deploy docker</code></pre></figure>

<p>Thanks to the above I created a blank project. So I could start by writing the logic of an application. First of all, I want to download information about available estates auctions in the city. I decided that by default I would download data for <code class="highlighter-rouge">Gdańsk</code>. Looking at the site with auctions I see that communication is done by forms:</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/search.jpg" alt="forms" /></p>

<p>The page gives a lot of possibilities to filter. In my situation only 2 of 26 options are relevant. City and the type of auction. Because of that, I look at how the request sent by a page looks like.</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/searchfill.jpg" alt="formsfinal" />
<img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/request.jpg" alt="request" /></p>

<p>Having information about how the request looks like I could implement it in code. I started by creating a new project named <code class="highlighter-rouge">Application</code> in my solution. In this project, all logic related to downloading/parsing data would be located. The page sends a simple POST request setting 2 of 26 fields, so the rewrite of this in F# looks as follow:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">fetchHtml</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">request</span> <span class="p">=</span>
        <span class="nn">Request</span><span class="p">.</span><span class="n">createUrl</span> <span class="nc">Post</span> <span class="s2">"http://www.licytacje.komornik.pl/Notice/Search"</span>
        <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">setHeader</span> <span class="p">(</span><span class="nc">Accept</span> <span class="s2">"application/json"</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">body</span> <span class="p">(</span><span class="nc">BodyForm</span>
            <span class="p">[</span>
                <span class="nc">NameValue</span> <span class="p">(</span><span class="s2">"Type"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">)</span>
                <span class="nc">NameValue</span> <span class="p">(</span><span class="s2">"City"</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span>
            <span class="o">])</span>
        <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">responseAsString</span>
        <span class="p">|&gt;</span> <span class="n">run</span>
    <span class="n">request</span></code></pre></figure>

<p>I used <a href="https://github.com/haf/Http.fs">http.fs</a> and <a href="https://github.com/Hopac/Hopac">hopac</a> libraries. In response, I get the full HTML page which I have to parse and gather the data I want to show on a map.</p>

<p>Going to parsing. I was thinking about using HtmlDocument, HtmlProvider, and HtmlAgilityPack. Because an app was written in F# the last option goes away. In terms of optimization of source files (I don’t want to have files of hundred of lines, because of templates “send” to HtmlProvider) the second option was also refused. So I used HtmlDocument. List of auctions looks like that:</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/list.jpg" alt="list" /></p>

<p>On a map, I want to show the localization of a property that would be auctioned. This information would be visualized as a marker on a map. The marker would have additional info with the data described earlier. Because of that for each record on a list, I have to gather the:</p>
<ul>
  <li>price;</li>
  <li>date of the auction;</li>
  <li>link to details.
So I wrote a code like this:</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="k">private</span> <span class="n">onlyNumbers</span> <span class="p">=</span> <span class="nc">Regex</span><span class="p">(</span><span class="s2">"[^0-9,]+"</span><span class="p">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="nc">Compiled</span><span class="p">)</span>
<span class="k">let</span> <span class="k">private</span> <span class="n">baseUrl</span> <span class="p">=</span> <span class="s2">"http://www.licytacje.komornik.pl"</span>

<span class="k">let</span> <span class="n">parseHtml</span> <span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">doc</span> <span class="p">=</span> <span class="nn">HtmlDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">html</span>

    <span class="n">doc</span><span class="p">.</span><span class="nc">CssSelect</span><span class="p">(</span><span class="s2">"table"</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">tryHead</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">tab</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">tab</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="n">x</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"tBody"</span> <span class="p">]</span>
            <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">tryHead</span>
            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">body</span> <span class="p">-&gt;</span>
                <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                <span class="p">|</span> <span class="nc">Some</span> <span class="n">v</span> <span class="p">-&gt;</span>
                    <span class="n">v</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"tr"</span> <span class="p">]</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">skip</span> <span class="mi">1</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span>
                        <span class="k">let</span> <span class="n">nOfElements</span> <span class="p">=</span>
                            <span class="n">y</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"td"</span> <span class="p">]</span>
                            <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
                        <span class="n">nOfElements</span> <span class="p">&gt;</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                        <span class="o">...</span>
                    <span class="p">)</span>
                <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">[]</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">[]</span></code></pre></figure>

<p>As you may notice. First, I parse the document. Look for a first table on a page and check if it has more than 1 record except for the header record. Otherwise, we want to pass an empty list.
If the data seems to be correct, I gather the concrete information. Price and the details link are located in the last 2 columns of a table. So the following fold/reduce line was written to gather only those two pieces of information.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="o">(_,</span> <span class="n">details</span><span class="p">)</span> <span class="p">=</span>
    <span class="nn">Seq</span><span class="p">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">i</span> <span class="p">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
                <span class="n">acc</span>
            <span class="k">else</span>
                <span class="n">e</span> <span class="p">::</span> <span class="n">acc</span><span class="o">))</span> <span class="n">columns</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">[]</span><span class="p">)</span>
<span class="k">let</span> <span class="n">prize</span> <span class="p">=</span>
    <span class="n">details</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">InnerText</span> <span class="bp">()</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">onlyNumbers</span><span class="p">.</span><span class="nc">Replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<span class="k">let</span> <span class="n">link</span> <span class="p">=</span>
    <span class="n">details</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">last</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"a"</span> <span class="p">]</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Attribute</span> <span class="s2">"href"</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span></code></pre></figure>

<p>Beyond that, I also get the information about the date of the auction. So here is the full code for parsing list properties:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="k">private</span> <span class="n">onlyNumbers</span> <span class="p">=</span> <span class="nc">Regex</span><span class="p">(</span><span class="s2">"[^0-9,]+"</span><span class="p">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="nc">Compiled</span><span class="p">)</span>
<span class="k">let</span> <span class="k">private</span> <span class="n">baseUrl</span> <span class="p">=</span> <span class="s2">"http://www.licytacje.komornik.pl"</span>

<span class="k">let</span> <span class="n">parseHtml</span> <span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">doc</span> <span class="p">=</span> <span class="nn">HtmlDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">html</span>

    <span class="n">doc</span><span class="p">.</span><span class="nc">CssSelect</span><span class="p">(</span><span class="s2">"table"</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">tryHead</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">tab</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">tab</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="n">x</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"tBody"</span> <span class="p">]</span>
            <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">tryHead</span>
            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">body</span> <span class="p">-&gt;</span>
                <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                <span class="p">|</span> <span class="nc">Some</span> <span class="n">v</span> <span class="p">-&gt;</span>
                    <span class="n">v</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"tr"</span> <span class="p">]</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">skip</span> <span class="mi">1</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span>
                        <span class="k">let</span> <span class="n">nOfElements</span> <span class="p">=</span>
                            <span class="n">y</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"td"</span> <span class="p">]</span>
                            <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
                        <span class="n">nOfElements</span> <span class="p">&gt;</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                        <span class="k">let</span> <span class="n">columns</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"td"</span> <span class="p">]</span>
                        <span class="k">let</span> <span class="n">``when``</span> <span class="p">=</span>
                            <span class="n">columns</span><span class="o">.[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                                <span class="nn">DateTime</span><span class="p">.</span><span class="nc">ParseExact</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nc">InnerText</span><span class="bp">()</span><span class="p">.</span><span class="nc">Trim</span><span class="bp">()</span><span class="p">,</span> <span class="s2">"dd.MM.yyyy"</span><span class="p">,</span> <span class="nn">CultureInfo</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="p">)</span>
                        <span class="k">let</span> <span class="o">(_,</span> <span class="n">details</span><span class="p">)</span> <span class="p">=</span>
                            <span class="nn">Seq</span><span class="p">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span> <span class="p">-&gt;</span>
                                <span class="p">(</span><span class="n">i</span> <span class="p">-</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
                                        <span class="n">acc</span>
                                    <span class="k">else</span>
                                        <span class="n">e</span> <span class="p">::</span> <span class="n">acc</span><span class="o">))</span> <span class="n">columns</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">[]</span><span class="p">)</span>
                        <span class="k">let</span> <span class="n">prize</span> <span class="p">=</span>
                            <span class="n">details</span>
                            <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">InnerText</span> <span class="bp">()</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">onlyNumbers</span><span class="p">.</span><span class="nc">Replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                        <span class="k">let</span> <span class="n">link</span> <span class="p">=</span>
                            <span class="n">details</span>
                            <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">last</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Elements</span> <span class="p">[</span> <span class="s2">"a"</span> <span class="p">]</span>
                            <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Attribute</span> <span class="s2">"href"</span>
                            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span>
                        <span class="p">{</span>
                            <span class="n">prize</span> <span class="p">=</span> <span class="p">(</span><span class="nn">Decimal</span><span class="p">.</span><span class="nc">Parse</span><span class="p">(</span><span class="n">prize</span><span class="p">.</span><span class="nc">Replace</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="s2">"."</span><span class="o">),</span> <span class="nn">CultureInfo</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="o">))</span>
                            <span class="n">link</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Uri</span><span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%s%s"</span> <span class="n">baseUrl</span> <span class="p">(</span><span class="n">link</span> <span class="bp">()</span><span class="o">)))</span>
                            <span class="n">``when``</span> <span class="p">=</span> <span class="n">``when``</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">[]</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">[]</span></code></pre></figure>

<p>Right now I have the full list of auctions. The only thing I still need is a localization of a home. I could get it from details of an auction, which looks like that:</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/details.jpg" alt="details" /></p>

<p>So right now for each sale, I download the full detail page. This fetch would be much easier than the previous one. Because I could use a simple GET request, which gonna looks like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">fetchAuction</span> <span class="n">link</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">request</span> <span class="p">=</span>
        <span class="nn">Request</span><span class="p">.</span><span class="n">createUrl</span> <span class="nc">Get</span> <span class="n">link</span>
        <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">setHeader</span> <span class="p">(</span><span class="nc">Accept</span> <span class="s2">"application/json"</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">responseAsString</span>
        <span class="p">|&gt;</span> <span class="n">run</span>
    <span class="n">request</span></code></pre></figure>

<p>After the download, I have to gather information about the localization which is located under the attribute <code class="highlighter-rouge">hidden_address</code> of an input. In addition to that, I also download a description of an auction. The code that realizes that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">parseAuction</span> <span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">doc</span> <span class="p">=</span> <span class="nn">HtmlDocument</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">html</span>

    <span class="k">let</span> <span class="n">address</span> <span class="p">=</span>
        <span class="n">doc</span><span class="p">.</span><span class="nc">CssSelect</span><span class="p">(</span><span class="s2">"input#hidden_address"</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">head</span>
        <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Attribute</span> <span class="s2">"value"</span>
        <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span> <span class="bp">()</span>
    <span class="k">let</span> <span class="n">description</span> <span class="p">=</span>
        <span class="n">doc</span><span class="p">.</span><span class="nc">CssSelect</span><span class="p">(</span><span class="s2">"div#Preview"</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">head</span>
        <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">InnerText</span> <span class="bp">()</span>
    <span class="n">async</span> <span class="p">{</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">coords</span> <span class="p">=</span> <span class="nn">Coordinates</span><span class="p">.</span><span class="n">translateAddressToCoords</span> <span class="n">address</span>
        <span class="k">match</span> <span class="n">coords</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="p">-&gt;</span>
            <span class="k">return</span> <span class="nc">Some</span> <span class="p">{</span>
                <span class="n">description</span> <span class="p">=</span> <span class="n">description</span>
                <span class="n">address</span> <span class="p">=</span> <span class="n">address</span>
                <span class="n">point</span> <span class="p">=</span> <span class="n">c</span>
            <span class="p">}</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="nc">None</span>
    <span class="p">}</span></code></pre></figure>

<p>The address is in the following format <code class="highlighter-rouge">city, street, house number</code> because I want to show it on a map I need to somehow translate it to longitude and latitude. This is why I pass the <code class="highlighter-rouge">human-readable</code> address to a <code class="highlighter-rouge">translateAddressToCoord</code> function which has a task of reverse geocoding. To achieve it I used <a href="https://nominatim.openstreetmap.org/">nominatim</a> service to which I send a GET request and then parse a response to get lng/lat.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">CoordinatesResponse</span> <span class="p">=</span> <span class="nc">JsonProvider</span><span class="p">&lt;</span><span class="s2">"""
[
  {
    "</span><span class="n">place_id</span><span class="s2">": 101573834,
    "</span><span class="n">licence</span><span class="s2">": "</span><span class="nc">Data</span> <span class="err">©</span> <span class="nc">OpenStreetMap</span> <span class="n">contributors</span><span class="p">,</span> <span class="nc">ODbL</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span> <span class="n">https</span><span class="o">://</span><span class="n">osm</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">copyright</span><span class="s2">",
    "</span><span class="n">osm_type</span><span class="s2">": "</span><span class="n">way</span><span class="s2">",
    "</span><span class="n">osm_id</span><span class="s2">": 111621751,
    "</span><span class="n">boundingbox</span><span class="s2">": [
      "</span><span class="mi">54</span><span class="p">.</span><span class="mi">3054945</span><span class="s2">",
      "</span><span class="mi">54</span><span class="p">.</span><span class="mi">3057362</span><span class="s2">",
      "</span><span class="mi">18</span><span class="p">.</span><span class="mi">5823766</span><span class="s2">",
      "</span><span class="mi">18</span><span class="p">.</span><span class="mi">5826803</span><span class="s2">"
    ],
    "</span><span class="n">lat</span><span class="s2">": "</span><span class="mi">54</span><span class="p">.</span><span class="mi">30561535</span><span class="s2">",
    "</span><span class="n">lon</span><span class="s2">": "</span><span class="mi">18</span><span class="p">.</span><span class="mi">58252845</span><span class="s2">",
    "</span><span class="n">display_name</span><span class="s2">": "</span><span class="nc">Some</span> <span class="nc">Street</span> <span class="mi">4</span><span class="p">,</span> <span class="nc">Gda</span><span class="err">ń</span><span class="n">sk</span><span class="p">,</span> <span class="n">wojew</span><span class="err">ó</span><span class="n">dztwo</span> <span class="n">pomorskie</span><span class="p">,</span> <span class="mi">80</span><span class="p">-</span><span class="mi">180</span><span class="p">,</span> <span class="nc">Polska</span><span class="s2">",
    "</span><span class="k">class</span><span class="s2">": "</span><span class="n">building</span><span class="s2">",
    "</span><span class="k">type</span><span class="s2">": "</span><span class="n">yes</span><span class="s2">",
    "</span><span class="n">importance</span><span class="s2">": 0.5309999999999999
  }
]
"""</span><span class="p">&gt;</span>

<span class="k">type</span> <span class="nc">Coordinate</span> <span class="p">=</span> <span class="n">decimal</span>

<span class="k">type</span> <span class="nc">Point</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">longitude</span><span class="p">:</span> <span class="nc">Coordinate</span>
        <span class="n">latitude</span><span class="p">:</span> <span class="nc">Coordinate</span>
    <span class="p">}</span>

<span class="k">module</span> <span class="nc">Coordinates</span> <span class="p">=</span>
    <span class="k">let</span> <span class="k">internal</span> <span class="n">parseResponse</span> <span class="p">(</span><span class="n">res</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
        <span class="nn">CoordinatesResponse</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">res</span>
        <span class="p">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">tryHead</span>
        <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Some</span> <span class="n">v</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="p">{</span> <span class="n">longitude</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="nc">Lon</span><span class="p">;</span> <span class="n">latitude</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="nc">Lat</span> <span class="p">}</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">None</span>

    <span class="k">let</span> <span class="n">translateAddressToCoords</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">async</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">request</span> <span class="p">=</span>
                <span class="nn">Request</span><span class="p">.</span><span class="n">createUrl</span> <span class="nc">Get</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"https://nominatim.openstreetmap.org/search?q=%s&amp;format=json"</span> <span class="n">address</span><span class="p">)</span>
                <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">setHeader</span> <span class="p">(</span><span class="nc">Accept</span> <span class="s2">"application/json"</span><span class="p">)</span>
                <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">setHeader</span> <span class="p">(</span><span class="nc">UserAgent</span> <span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36"</span><span class="p">)</span>
                <span class="p">|&gt;</span> <span class="nn">Request</span><span class="p">.</span><span class="n">responseAsString</span>
                <span class="p">|&gt;</span> <span class="n">run</span>
            <span class="k">do</span><span class="o">!</span> <span class="nn">Task</span><span class="p">.</span><span class="nc">Delay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">AwaitTask</span>
            <span class="k">return</span> <span class="n">request</span> <span class="p">|&gt;</span> <span class="n">parseResponse</span>
        <span class="p">}</span></code></pre></figure>

<p>Here I decided to use JsonProvider, because the response from service has a strict format. After sending a request, I parse it via JsonProvider and then gather longitude/latitude information.</p>

<p>Right now I have all the data needed. So the only thing to do is to combine them:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="k">internal</span> <span class="nc">Auction</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">prize</span><span class="p">:</span> <span class="nc">Prize</span>
        <span class="n">``when``</span><span class="p">:</span> <span class="nc">Date</span>
        <span class="n">link</span><span class="p">:</span> <span class="nc">Link</span>
        <span class="n">details</span><span class="p">:</span> <span class="nc">Details</span>
    <span class="p">}</span>

<span class="k">type</span> <span class="nc">AuctionInformation</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">prize</span><span class="p">:</span> <span class="nc">Prize</span>
        <span class="n">link</span><span class="p">:</span> <span class="nc">Link</span>
        <span class="n">description</span><span class="p">:</span> <span class="nc">Info</span>
        <span class="n">``when``</span><span class="p">:</span> <span class="nc">Date</span>
        <span class="n">point</span><span class="p">:</span> <span class="nc">Point</span>
    <span class="p">}</span>

<span class="k">module</span> <span class="nc">Auctions</span> <span class="p">=</span>
    <span class="k">let</span> <span class="k">private</span> <span class="n">getConcreteAuction</span> <span class="p">(</span><span class="n">auction</span><span class="p">:</span> <span class="nc">BaseAuction</span><span class="p">)</span> <span class="p">=</span>
        <span class="nn">Fetcher</span><span class="p">.</span><span class="n">fetchAuction</span> <span class="n">auction</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="nc">AbsoluteUri</span>
        <span class="p">|&gt;</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">parseAuction</span>

    <span class="k">let</span> <span class="n">get</span> <span class="p">=</span>
        <span class="nn">Fetcher</span><span class="p">.</span><span class="n">fetchHtml</span>
        <span class="o">&gt;&gt;</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">parseHtml</span>
        <span class="o">&gt;&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="k">let</span> <span class="n">concreteAuctions</span> <span class="p">=</span> <span class="nn">Fetcher</span><span class="p">.</span><span class="n">fetchAuctions</span> <span class="p">(</span><span class="n">x</span> <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="n">y</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="nc">AbsoluteUri</span><span class="o">))</span>
            <span class="n">async</span> <span class="p">{</span>
                <span class="k">let</span><span class="o">!</span> <span class="n">result</span> <span class="p">=</span>
                    <span class="n">x</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span>
                        <span class="n">async</span> <span class="p">{</span>
                            <span class="k">let</span><span class="o">!</span> <span class="n">details</span> <span class="p">=</span> <span class="n">getConcreteAuction</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
                            <span class="k">match</span> <span class="n">details</span> <span class="k">with</span>
                            <span class="p">|</span> <span class="nc">Some</span> <span class="n">d</span> <span class="p">-&gt;</span>
                                <span class="k">let</span> <span class="n">info</span> <span class="p">=</span>
                                    <span class="n">sprintf</span> <span class="s2">"Prize: %M zł, property located near: %s, auction at: %s"</span> <span class="n">y</span><span class="p">.</span><span class="n">prize</span> <span class="n">d</span><span class="p">.</span><span class="n">address</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">``when``</span><span class="p">.</span><span class="nc">ToString</span><span class="p">(</span><span class="s2">"dd/MM/yyyy"</span><span class="o">))</span>
                                <span class="k">return</span> <span class="o">[{</span>
                                    <span class="n">prize</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">prize</span>
                                    <span class="n">link</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">link</span>
                                    <span class="n">description</span> <span class="p">=</span> <span class="n">info</span>
                                    <span class="n">point</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">point</span>
                                    <span class="n">``when``</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">``when``</span>
                                <span class="o">}]</span>
                            <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="bp">[]</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toSeq</span>
                    <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Parallel</span>
                <span class="k">return</span> <span class="n">result</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">collect</span> <span class="n">id</span>
            <span class="p">}</span></code></pre></figure>

<p>and return as a model which is defined like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Prize</span> <span class="p">=</span> <span class="n">decimal</span>
<span class="k">type</span> <span class="nc">Link</span> <span class="p">=</span> <span class="kt">string</span>
<span class="k">type</span> <span class="nc">Info</span> <span class="p">=</span> <span class="kt">string</span>
<span class="k">type</span> <span class="nc">Address</span> <span class="p">=</span> <span class="kt">string</span>
<span class="k">type</span> <span class="nc">Date</span> <span class="p">=</span> <span class="nn">System</span><span class="p">.</span><span class="nc">DateTime</span>
<span class="k">type</span> <span class="nc">Coordinate</span> <span class="p">=</span> <span class="n">decimal</span>

<span class="k">type</span> <span class="nc">Localization</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">longitude</span><span class="p">:</span> <span class="nc">Coordinate</span>
        <span class="n">latitude</span><span class="p">:</span> <span class="nc">Coordinate</span>
    <span class="p">}</span>

<span class="k">type</span> <span class="nc">Auction</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">prize</span><span class="p">:</span> <span class="nc">Prize</span>
        <span class="n">link</span><span class="p">:</span> <span class="nc">Link</span>
        <span class="n">description</span><span class="p">:</span> <span class="nc">Info</span>
        <span class="n">``when``</span><span class="p">:</span> <span class="nc">Date</span>
        <span class="n">localization</span><span class="p">:</span> <span class="nc">Localization</span>
    <span class="p">}</span></code></pre></figure>

<p>Mapping looks like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">mapToContract</span> <span class="p">(</span><span class="n">ai</span><span class="p">:</span> <span class="nc">AuctionInformation</span><span class="o">):</span> <span class="nn">Shared</span><span class="p">.</span><span class="nc">Auction</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">prize</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">prize</span>
        <span class="n">link</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="nc">AbsoluteUri</span>
        <span class="n">description</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">description</span>
        <span class="n">``when``</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">``when``</span><span class="p">.</span><span class="nc">Date</span>
        <span class="n">localization</span> <span class="p">=</span> <span class="p">{</span>
            <span class="n">longitude</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">longitude</span>
            <span class="n">latitude</span> <span class="p">=</span> <span class="n">ai</span><span class="p">.</span><span class="n">point</span><span class="p">.</span><span class="n">latitude</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>I can go right now to the definition of the interface between the back and frontend. The interface would look like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">IAuctionsApi</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">init</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Result</span><span class="p">&lt;</span><span class="nc">Auction</span> <span class="n">seq</span><span class="p">,</span> <span class="n">exn</span><span class="o">&gt;&gt;</span>
        <span class="n">filtered</span> <span class="p">:</span> <span class="kt">string</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Result</span><span class="p">&lt;</span><span class="nc">Auction</span> <span class="n">seq</span><span class="p">,</span> <span class="n">exn</span><span class="o">&gt;&gt;</span>
    <span class="p">}</span></code></pre></figure>

<p>And implementation:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">auctionsApi</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">init</span> <span class="p">=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span>
        <span class="k">try</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">auctions</span> <span class="p">=</span> <span class="nn">Auctions</span><span class="p">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">"Gdańsk"</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">mapped</span> <span class="p">=</span>
                <span class="n">auctions</span>
                <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">mapToContract</span>
            <span class="k">return</span> <span class="nc">Ok</span> <span class="n">mapped</span>
        <span class="k">with</span>
        <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="nc">Error</span> <span class="n">ex</span>
    <span class="p">}</span>

    <span class="n">filtered</span> <span class="p">=</span> <span class="k">fun</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span>
        <span class="k">try</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">auctions</span> <span class="p">=</span>
                <span class="k">match</span> <span class="n">city</span> <span class="k">with</span>
                <span class="p">|</span> <span class="n">c</span> <span class="k">when</span> <span class="nn">String</span><span class="p">.</span><span class="n">isEmpty</span> <span class="n">c</span> <span class="p">-&gt;</span> <span class="nn">Auctions</span><span class="p">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">"Gdańsk"</span><span class="p">)</span>
                <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nn">Auctions</span><span class="p">.</span><span class="n">get</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">auctions</span>
                <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">mapToContract</span>
                <span class="p">|&gt;</span> <span class="nc">Ok</span>
        <span class="k">with</span>
        <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="nc">Error</span> <span class="n">ex</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>It would give a possibility to download the default data, and filtered one based on some keyword (city name).</p>

<p>As long as a shared model between client and server is done right now. The server is also ready. We could go to the frontend part of an application. Which needs to be adjusted. I start by showing a blank map. So I have to install 2 libraries:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">Fable</span><span class="p">.</span><span class="nc">Leaflet</span>
<span class="nn">Fable</span><span class="p">.</span><span class="nc">ReactLeaflet</span></code></pre></figure>

<p>Next thing is to adjust messages that would be sent across the application. I created the following messages:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Msg</span> <span class="p">=</span>
    <span class="p">|</span> <span class="nc">Search</span> <span class="k">of</span> <span class="kt">string</span>
    <span class="p">|</span> <span class="nc">SearchChanged</span> <span class="k">of</span> <span class="kt">string</span>
    <span class="p">|</span> <span class="nc">Filtered</span> <span class="k">of</span> <span class="nc">Result</span><span class="p">&lt;</span><span class="nc">Auction</span> <span class="n">seq</span><span class="p">,</span> <span class="n">exn</span><span class="p">&gt;</span>
    <span class="p">|</span> <span class="nc">Init</span> <span class="k">of</span> <span class="nc">Result</span><span class="p">&lt;</span><span class="nc">Auction</span> <span class="n">seq</span><span class="p">,</span> <span class="n">exn</span><span class="p">&gt;</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="k">of</span> <span class="n">exn</span></code></pre></figure>

<p>I thought that every user could:</p>
<ul>
  <li>change input (SearchChanged);</li>
  <li>submit input (Search).</li>
</ul>

<p>And the server could respond with:</p>
<ul>
  <li>initial data (Init);</li>
  <li>filtered data (Filtered);</li>
  <li>error (Error).
As long as messages were defined as follow we could go to the message handling.</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Model</span> <span class="p">=</span> <span class="p">{</span> <span class="nc">Search</span><span class="p">:</span> <span class="kt">string</span><span class="p">;</span> <span class="nc">Auctions</span><span class="p">:</span> <span class="nc">Auction</span> <span class="n">seq</span><span class="p">;</span> <span class="nc">Zoom</span><span class="p">:</span> <span class="nc">LatLngExpression</span><span class="p">}</span>

<span class="k">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">msg</span> <span class="p">:</span> <span class="nc">Msg</span><span class="p">)</span> <span class="p">(</span><span class="n">currentModel</span> <span class="p">:</span> <span class="nc">Model</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Model</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">currentModel</span><span class="p">.</span><span class="nc">Auctions</span><span class="p">,</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="nc">Search</span> <span class="n">city</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">search</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofAsync</span> <span class="n">search</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="nc">Filtered</span> <span class="nc">Error</span>
        <span class="n">currentModel</span><span class="p">,</span> <span class="n">search</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="nc">SearchChanged</span> <span class="n">city</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">nextModel</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentModel</span> <span class="k">with</span> <span class="nc">Search</span> <span class="p">=</span> <span class="n">city</span> <span class="p">}</span>
        <span class="n">nextModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="nc">Filtered</span> <span class="n">possibleAuctions</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">possibleAuctions</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">auc</span> <span class="p">-&gt;</span>
          <span class="k">let</span> <span class="n">zoomToFirst</span> <span class="p">=</span>
            <span class="n">auc</span>
            <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">tryHead</span>
            <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
              <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
              <span class="p">|</span> <span class="nc">Some</span> <span class="n">a</span> <span class="p">-&gt;</span>
                <span class="p">(</span><span class="nn">Fable</span><span class="p">.</span><span class="nn">Core</span><span class="p">.</span><span class="nn">U3</span><span class="p">.</span><span class="nc">Case3</span> <span class="p">(</span>
                    <span class="n">a</span><span class="p">.</span><span class="n">localization</span><span class="p">.</span><span class="n">latitude</span>
                    <span class="p">|&gt;</span> <span class="kt">float</span><span class="p">,</span>
                    <span class="n">a</span><span class="p">.</span><span class="n">localization</span><span class="p">.</span><span class="n">longitude</span>
                    <span class="p">|&gt;</span> <span class="kt">float</span><span class="p">)</span>
                <span class="p">)</span>
              <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">currentModel</span><span class="p">.</span><span class="nc">Zoom</span>
          <span class="k">let</span> <span class="n">nextModel</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentModel</span> <span class="k">with</span> <span class="nc">Auctions</span> <span class="p">=</span> <span class="n">auc</span><span class="p">;</span> <span class="nc">Zoom</span> <span class="p">=</span> <span class="n">zoomToFirst</span> <span class="p">}</span>
          <span class="n">nextModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
        <span class="p">|</span> <span class="nn">Result</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">currentModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="p">(</span><span class="nc">Error</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="nc">Init</span> <span class="n">possibleAuction</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">possibleAuction</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">auc</span> <span class="p">-&gt;</span>
          <span class="k">let</span> <span class="n">nextModel</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentModel</span> <span class="k">with</span> <span class="nc">Auctions</span> <span class="p">=</span> <span class="n">auc</span> <span class="p">}</span>
          <span class="n">nextModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
        <span class="p">|</span> <span class="nn">Result</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">currentModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="p">(</span><span class="nc">Error</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="nn">JS</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%s%s%s"</span> <span class="n">e</span><span class="p">.</span><span class="nc">Message</span> <span class="s2">" "</span> <span class="n">e</span><span class="p">.</span><span class="nc">StackTrace</span><span class="p">)</span>
        <span class="n">currentModel</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Based on a type of a message I change the actual state of an application (SearchChanged, Error, Init, Filtered) or ask the backend side for data (Search). Also if the message would have an error msg inside I send another command with <code class="highlighter-rouge">Error</code>.</p>

<p>The code looks pretty simple. You could notice that we have here a <code class="highlighter-rouge">cascade</code> of messages. For example, when a user submits an input a server action is invoked. When it returns some data, a <code class="highlighter-rouge">filtered</code> or <code class="highlighter-rouge">error</code> message are sent. One handling looks a little bit different. It is a <code class="highlighter-rouge">filtered</code> message handling, where the calculation of localization of the first home also happens. So the map could be moved to this point. No matter which city user would search. The map will auto adjust to a valid region. Of course, I could count here a centroid of all points but I want to keep it very simple.</p>

<p>The definition and handling of messages are done. So I could show a map without any markers. I would show a leaflet map. To add it, I wrote the following code:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">RL</span> <span class="p">=</span> <span class="nn">ReactLeaflet</span>

<span class="p">...</span>

<span class="nn">RL</span><span class="p">.</span><span class="n">map</span> <span class="p">[</span>
    <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Zoom</span> <span class="mi">10</span><span class="p">.</span>
    <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Style</span>
        <span class="p">[</span>
            <span class="nc">Height</span> <span class="mi">500</span>
            <span class="nc">MinWidth</span> <span class="mi">200</span>
            <span class="nc">Width</span> <span class="nn">Column</span><span class="p">.</span><span class="nc">IsFull</span>
        <span class="p">]</span>
        <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Center</span> <span class="n">model</span><span class="p">.</span><span class="nc">Zoom</span>
    <span class="p">]</span>
            <span class="p">(</span><span class="n">mapElements</span> <span class="n">model</span><span class="p">)</span></code></pre></figure>

<p>I define zoom, width, height, the center of a map. There are some key aspects, that you couldn’t omit if you want to show a leaflet map:</p>
<ul>
  <li>you have to set some width/height of a map, otherwise, the map wouldn’t show;</li>
  <li>you have to set map center, otherwise, the map would be grey;</li>
  <li>you have to add a tile layer;</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">ReactLeaflet</span><span class="p">.</span><span class="n">tileLayer</span>
    <span class="p">[</span> <span class="nn">ReactLeaflet</span><span class="p">.</span><span class="nn">TileLayerProps</span><span class="p">.</span><span class="nc">Url</span> <span class="s2">"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"</span>
      <span class="nn">ReactLeaflet</span><span class="p">.</span><span class="nn">TileLayerProps</span><span class="p">.</span><span class="nc">Attribution</span> <span class="s2">"&amp;amp;copy &lt;a href=&amp;quot;http://osm.org/copyright&amp;quot;&gt;OpenStreetMap&lt;/a&gt; contributors"</span> <span class="p">]</span>
    <span class="bp">[]</span></code></pre></figure>

<ul>
  <li>you have to import leaflet styles;</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">importAll</span> <span class="s2">"../../node_modules/leaflet/dist/leaflet.css"</span></code></pre></figure>

<ul>
  <li>you have to change the default imagepath for an icon, otherwise you would get errors in console;</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">Leaflet</span><span class="p">.</span><span class="n">icon</span><span class="p">?</span><span class="nc">Default</span><span class="p">?</span><span class="n">imagePath</span> <span class="p">&lt;-</span> <span class="s2">"//cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/"</span></code></pre></figure>

<ul>
  <li>you should not forget to add to package.json leaflet packages</li>
</ul>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
    <span class="dl">"</span><span class="s2">leaflet</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.6.0</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">react-leaflet</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2.6.1</span><span class="dl">"</span>
<span class="p">}</span></code></pre></figure>

<p>Having in mind above, a map should be visible.</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/blank.jpg" alt="map" /></p>

<p>Having a blank map, I could show some markers on it. Previously I show how to handle messages with data information about auctions. These auctions are available in an app state. Thanks to that, I could show some markers. This is why <code class="highlighter-rouge">mapElements</code> function was created:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">RL</span><span class="p">.</span><span class="n">map</span>
    <span class="p">[</span>
        <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Zoom</span> <span class="mi">10</span><span class="p">.</span>
        <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Style</span>
        <span class="p">[</span>
            <span class="nc">Height</span> <span class="mi">500</span>
            <span class="nc">MinWidth</span> <span class="mi">200</span>
            <span class="nc">Width</span> <span class="nn">Column</span><span class="p">.</span><span class="nc">IsFull</span>
        <span class="p">]</span>
        <span class="nn">RL</span><span class="p">.</span><span class="nn">MapProps</span><span class="p">.</span><span class="nc">Center</span> <span class="n">model</span><span class="p">.</span><span class="nc">Zoom</span>
    <span class="p">]</span>
           <span class="p">(</span><span class="n">mapElements</span> <span class="n">model</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">RL</span> <span class="p">=</span> <span class="nn">ReactLeaflet</span>

<span class="p">...</span>

<span class="n">let</span> <span class="n">buildMarker</span> <span class="p">(</span><span class="n">auction</span><span class="p">:</span> <span class="nc">Auction</span><span class="o">):</span> <span class="nc">ReactElement</span> <span class="p">=</span>
    <span class="nn">RL</span><span class="p">.</span><span class="n">marker</span>
      <span class="p">[</span>
        <span class="nn">RL</span><span class="p">.</span><span class="nn">MarkerProps</span><span class="p">.</span><span class="nc">Position</span> <span class="p">(</span><span class="nn">Fable</span><span class="p">.</span><span class="nn">Core</span><span class="p">.</span><span class="nn">U3</span><span class="p">.</span><span class="nc">Case3</span> <span class="p">(</span><span class="n">auction</span><span class="p">.</span><span class="n">localization</span><span class="p">.</span><span class="n">latitude</span> <span class="p">|&gt;</span> <span class="kt">float</span><span class="p">,</span> <span class="n">auction</span><span class="p">.</span><span class="n">localization</span><span class="p">.</span><span class="n">longitude</span> <span class="p">|&gt;</span> <span class="kt">float</span><span class="o">))</span> <span class="p">]</span>
      <span class="p">[</span> <span class="nn">RL</span><span class="p">.</span><span class="n">popup</span>
          <span class="p">[</span> <span class="nn">RL</span><span class="p">.</span><span class="nn">PopupProps</span><span class="p">.</span><span class="nc">Key</span> <span class="p">(</span><span class="n">auction</span><span class="p">.</span><span class="n">link</span> <span class="p">|&gt;</span> <span class="kt">string</span><span class="o">)]</span>
          <span class="p">[</span> <span class="nn">Control</span><span class="p">.</span><span class="n">p</span>
              <span class="bp">[]</span>
              <span class="p">[</span> <span class="n">label</span> <span class="bp">[]</span> <span class="p">[</span> <span class="o">!!</span><span class="n">auction</span><span class="p">.</span><span class="n">description</span> <span class="p">]</span> <span class="p">]</span>
            <span class="nn">Control</span><span class="p">.</span><span class="n">p</span>
                <span class="bp">[]</span>
                <span class="p">[</span> <span class="nn">Button</span><span class="p">.</span><span class="n">a</span>
                    <span class="p">[</span> <span class="nn">Button</span><span class="p">.</span><span class="nc">Size</span> <span class="nc">IsSmall</span>
                      <span class="nn">Button</span><span class="p">.</span><span class="nc">Props</span> <span class="p">[</span> <span class="nc">Href</span> <span class="p">(</span><span class="n">auction</span><span class="p">.</span><span class="n">link</span> <span class="p">|&gt;</span> <span class="kt">string</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="nn">Icon</span><span class="p">.</span><span class="n">icon</span> <span class="p">[</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="nn">Fa</span><span class="p">.</span><span class="n">i</span> <span class="p">[</span><span class="nn">Fa</span><span class="p">.</span><span class="nn">Brand</span><span class="p">.</span><span class="nc">Github</span><span class="p">;</span> <span class="nn">Fa</span><span class="p">.</span><span class="nc">FixedWidth</span><span class="p">]</span> <span class="bp">[]</span> <span class="p">]</span>
                      <span class="n">span</span> <span class="p">[</span> <span class="p">]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Go to bailif description"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">mapElements</span> <span class="n">model</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">markers</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nc">Auctions</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">buildMarker</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>
  <span class="n">tile</span> <span class="p">::</span> <span class="n">markers</span></code></pre></figure>

<p>For each element in a table I get from a server I create a marker. Set the position of it and create a popup with a short description of the auction (price, date, link to details).</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/markers.jpg" alt="map" /></p>

<p>The map and markers are visible. The only missing thing is an input that would accept strings and would trigger a search “function” after pushing the <code class="highlighter-rouge">submit</code> button. Code that is responsible for rendering a button:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">Box</span><span class="p">.</span><span class="n">box'</span> <span class="p">[</span> <span class="p">]</span>
        <span class="p">[</span> <span class="nn">Field</span><span class="p">.</span><span class="n">div</span> <span class="p">[</span> <span class="nn">Field</span><span class="p">.</span><span class="nc">IsGrouped</span> <span class="p">]</span>
            <span class="p">[</span> <span class="nn">Control</span><span class="p">.</span><span class="n">p</span> <span class="p">[</span> <span class="nn">Control</span><span class="p">.</span><span class="nc">IsExpanded</span> <span class="p">]</span>
                <span class="p">[</span> <span class="nn">Input</span><span class="p">.</span><span class="n">text</span>
                    <span class="p">[</span> <span class="nn">Input</span><span class="p">.</span><span class="nc">Disabled</span> <span class="bp">false</span>
                      <span class="nn">Input</span><span class="p">.</span><span class="nc">Value</span> <span class="n">model</span><span class="p">.</span><span class="nc">Search</span>
                      <span class="nn">Input</span><span class="p">.</span><span class="nc">OnChange</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">dispatch</span> <span class="p">(</span><span class="nc">SearchChanged</span> <span class="n">e</span><span class="p">.</span><span class="nc">Value</span><span class="o">))</span> <span class="p">]</span> <span class="p">]</span>
              <span class="nn">Control</span><span class="p">.</span><span class="n">p</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="nn">Button</span><span class="p">.</span><span class="n">a</span>
                    <span class="p">[</span> <span class="nn">Button</span><span class="p">.</span><span class="nc">Color</span> <span class="nc">IsPrimary</span>
                      <span class="nn">Button</span><span class="p">.</span><span class="nc">OnClick</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">dispatch</span> <span class="p">(</span><span class="nc">Search</span> <span class="n">model</span><span class="p">.</span><span class="nc">Search</span><span class="o">))</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Search"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>Handler of a Search message (just a reminder):</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">...</span>
<span class="p">|</span> <span class="o">_,</span> <span class="nc">Search</span> <span class="n">city</span> <span class="p">-&gt;</span>
    <span class="k">let</span> <span class="n">search</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofAsync</span> <span class="n">search</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="nc">Filtered</span> <span class="nc">Error</span>
    <span class="n">currentModel</span><span class="p">,</span> <span class="n">search</span>
<span class="o">...</span></code></pre></figure>

<p>The whole application is ready so I create a docker image:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">fake</span> <span class="n">build</span> <span class="o">--</span><span class="n">target</span> <span class="n">docker</span></code></pre></figure>

<p>Small adjustment to build.fsx, so my image would have an additional tag.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">dockerFullName</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">"%s/%s"</span> <span class="n">dockerUser</span> <span class="n">dockerImageName</span>

<span class="nn">Target</span><span class="p">.</span><span class="n">create</span> <span class="s2">"Docker"</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
    <span class="n">buildDocker</span> <span class="n">dockerFullName</span>
<span class="p">)</span></code></pre></figure>

<p>Push to docker hub:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker push user/image:tag</code></pre></figure>

<p>Creation of Web App on Azure</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/dockersetup.png" alt="creation" /></p>

<p>When the deployment is ready I need to do one additional thing (as SAFE stack docs <a href="https://safe-stack.github.io/docs/template-docker/">stated</a>). We need to map port 8085 which is used by Giraffe to port 80.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">az webapp config appsettings <span class="nb">set</span> <span class="nt">--resource-group</span> RESOURCE <span class="nt">--name</span> APPNAME <span class="nt">--settings</span> <span class="nv">WEBSITES_PORT</span><span class="o">=</span>8085</code></pre></figure>

<p>How finally the applications looks like:</p>

<p><img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/withoutmarkers.jpg" alt="final" /></p>

<p>Right now I could finish this article. But as you may see in the above picture there is a map without any markers. Why? Because a page from which I scrap the data change a little bit from time when I implement the whole application. In every request, there should be included a <code class="highlighter-rouge">_requestValidation</code> field and a <code class="highlighter-rouge">cookie</code>. I decided that instead of that I would use the <code class="highlighter-rouge">canopy</code> to gather a full page after some on-site filtering. I modified code responsible for downloading a list of auctions:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="k">private</span> <span class="n">search</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="p">(</span><span class="n">elements</span> <span class="s2">".city"</span><span class="o">).</span><span class="nc">Length</span> <span class="p">&gt;</span> <span class="mi">0</span>

<span class="k">let</span> <span class="k">private</span> <span class="n">startChrome</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">chromeOptions</span> <span class="p">=</span> <span class="nc">ChromeOptions</span><span class="bp">()</span>
    <span class="n">chromeOptions</span><span class="p">.</span><span class="nc">AddArgument</span><span class="p">(</span><span class="s2">"--no-sandbox"</span><span class="p">)</span>
    <span class="n">chromeOptions</span><span class="p">.</span><span class="nc">AddArgument</span><span class="p">(</span><span class="s2">"--headless"</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">chromeNoSandbox</span> <span class="p">=</span> <span class="nc">ChromeWithOptions</span><span class="p">(</span><span class="n">chromeOptions</span><span class="p">)</span>
    <span class="n">start</span> <span class="n">chromeNoSandbox</span>

<span class="k">let</span> <span class="n">fetchHtml</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">startChrome</span> <span class="bp">()</span>

    <span class="n">url</span> <span class="s2">"http://www.licytacje.komornik.pl/Notice/Search"</span>
    <span class="n">waitFor</span> <span class="n">search</span>
    <span class="s2">".city"</span> <span class="o">&lt;&lt;</span> <span class="n">city</span>
    <span class="n">click</span> <span class="s2">"#Type"</span>
    <span class="n">click</span> <span class="s2">"Nieruchomość"</span>
    <span class="n">click</span> <span class="s2">".button_next_active"</span>

    <span class="k">let</span> <span class="n">page</span> <span class="p">=</span> <span class="n">browser</span><span class="p">.</span><span class="nc">PageSource</span>
    <span class="n">quit</span> <span class="bp">()</span>

    <span class="n">page</span></code></pre></figure>

<p>As I said I used a <code class="highlighter-rouge">canopy</code> library. I open a headless chrome browser which is hidden for a client. I open a page, search for a city and click “search”. In the end, I download the full page and that’s all. Parsing would look the same, no changes required.</p>

<p>The code for downloading a single auction was also modified to use a <code class="highlighter-rouge">canopy</code>. I thought that it would be a huge benefit in terms of performance to open a browser once and for each auction go to the site and download it. Downloading all auctions at once is achieved like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="k">private</span> <span class="n">startChrome</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">chromeOptions</span> <span class="p">=</span> <span class="nc">ChromeOptions</span><span class="bp">()</span>
    <span class="n">chromeOptions</span><span class="p">.</span><span class="nc">AddArgument</span><span class="p">(</span><span class="s2">"--no-sandbox"</span><span class="p">)</span>
    <span class="n">chromeOptions</span><span class="p">.</span><span class="nc">AddArgument</span><span class="p">(</span><span class="s2">"--headless"</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">chromeNoSandbox</span> <span class="p">=</span> <span class="nc">ChromeWithOptions</span><span class="p">(</span><span class="n">chromeOptions</span><span class="p">)</span>
    <span class="n">start</span> <span class="n">chromeNoSandbox</span>

<span class="k">let</span> <span class="n">fetchAuctions</span> <span class="n">links</span> <span class="p">=</span>
    <span class="n">startChrome</span> <span class="bp">()</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">fetchDetails</span> <span class="n">alreadyFetched</span> <span class="n">toCheck</span> <span class="p">=</span>
        <span class="k">match</span> <span class="n">toCheck</span> <span class="k">with</span>
        <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span> <span class="n">alreadyFetched</span>
        <span class="p">|</span> <span class="n">head</span><span class="p">::</span><span class="n">tail</span> <span class="p">-&gt;</span>
            <span class="n">url</span> <span class="n">head</span>
            <span class="k">let</span> <span class="n">page</span> <span class="p">=</span> <span class="n">browser</span><span class="p">.</span><span class="nc">PageSource</span>
            <span class="k">let</span> <span class="n">v</span> <span class="p">=</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
            <span class="n">fetchDetails</span> <span class="p">(</span><span class="n">v</span><span class="p">::</span><span class="n">alreadyFetched</span><span class="p">)</span> <span class="n">tail</span>

    <span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="n">fetchDetails</span> <span class="bp">[]</span> <span class="n">links</span>
    <span class="n">quit</span> <span class="bp">()</span>

    <span class="n">dict</span> <span class="n">result</span></code></pre></figure>

<p>And invoked like that:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">Auctions</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">get</span> <span class="p">=</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">chromeDir</span> <span class="p">&lt;-</span> <span class="nn">AppDomain</span><span class="p">.</span><span class="nn">CurrentDomain</span><span class="p">.</span><span class="nc">BaseDirectory</span>

        <span class="nn">Fetcher</span><span class="p">.</span><span class="n">fetchHtml</span>
        <span class="o">&gt;&gt;</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">parseHtml</span>
        <span class="o">&gt;&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="k">let</span> <span class="n">concreteAuctions</span> <span class="p">=</span> <span class="nn">Fetcher</span><span class="p">.</span><span class="n">fetchAuctions</span> <span class="p">(</span><span class="n">x</span> <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="n">y</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="nc">AbsoluteUri</span><span class="o">))</span>
            <span class="n">async</span> <span class="p">{</span>
                <span class="k">let</span><span class="o">!</span> <span class="n">result</span> <span class="p">=</span>
                    <span class="n">x</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span>
                        <span class="n">async</span> <span class="p">{</span>
                            <span class="k">let</span> <span class="n">auction</span> <span class="p">=</span> <span class="n">concreteAuctions</span><span class="o">.[</span> <span class="n">y</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="nc">AbsoluteUri</span> <span class="p">]</span>
                            <span class="k">let</span><span class="o">!</span> <span class="n">details</span> <span class="p">=</span> <span class="n">auction</span> <span class="p">|&gt;</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">parseAuction</span>
                            <span class="k">match</span> <span class="n">details</span> <span class="k">with</span>
                            <span class="p">|</span> <span class="nc">Some</span> <span class="n">d</span> <span class="p">-&gt;</span>
                                <span class="k">let</span> <span class="n">info</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">"Prize: %M zł, property located near: %s, auction at: %s"</span> <span class="n">y</span><span class="p">.</span><span class="n">prize</span> <span class="n">d</span><span class="p">.</span><span class="n">address</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">``when``</span><span class="p">.</span><span class="nc">ToString</span><span class="p">(</span><span class="s2">"dd/MM/yyyy"</span><span class="o">))</span>
                                <span class="k">return</span> <span class="o">[{</span>
                                    <span class="n">prize</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">prize</span>
                                    <span class="n">link</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">link</span>
                                    <span class="n">description</span> <span class="p">=</span> <span class="n">info</span>
                                    <span class="n">point</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">point</span>
                                    <span class="n">``when``</span> <span class="p">=</span> <span class="n">y</span><span class="p">.</span><span class="n">``when``</span>
                                <span class="o">}]</span>
                            <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="bp">[]</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toSeq</span>
                    <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Parallel</span>
                <span class="k">return</span> <span class="n">result</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">collect</span> <span class="n">id</span>
            <span class="p">}</span></code></pre></figure>

<p>And finally application looks like that:
<img src="https://mnie.github.com/img/08-01-2020AuctionsVisualizationWithFable/marker.jpg" alt="final" /></p>

<p>The only minus of a <code class="highlighter-rouge">new</code> solution is the performance. Because the previous solution was a lot faster.</p>

<p>Right now everything should work just fine locally. I need some adjustments so the canopy would be run inside of a docker. To make it happen I have to do the following things:</p>
<ul>
  <li>copy chrome driver in a server.fsproj to output folder;</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="p">&lt;</span><span class="nc">ItemGroup</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nc">Content</span> <span class="nc">Include</span><span class="p">=</span><span class="s2">"chromedriver.exe"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">CopyToOutputDirectory</span><span class="p">&gt;</span><span class="nc">CopyAlways</span><span class="o">&lt;/</span><span class="nc">CopyToOutputDirectory</span><span class="p">&gt;</span>
<span class="o">&lt;/</span><span class="nc">Content</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nc">Content</span> <span class="nc">Include</span><span class="p">=</span><span class="s2">"chromedriver"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">CopyToOutputDirectory</span><span class="p">&gt;</span><span class="nc">CopyAlways</span><span class="o">&lt;/</span><span class="nc">CopyToOutputDirectory</span><span class="p">&gt;</span>
<span class="o">&lt;/</span><span class="nc">Content</span><span class="p">&gt;</span>
<span class="o">&lt;/</span><span class="nc">ItemGroup</span><span class="p">&gt;</span></code></pre></figure>

<ul>
  <li>install chrome in a docker image.</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nc">ENV</span> <span class="nc">CHROME_DRIVER_VERSION</span> <span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3945</span><span class="p">.</span><span class="mi">36</span>

<span class="nc">RUN</span> <span class="n">apt</span><span class="p">-</span><span class="n">get</span> <span class="n">update</span> <span class="p">&amp;&amp;</span> <span class="n">apt</span><span class="p">-</span><span class="n">get</span> <span class="n">install</span> <span class="p">-</span><span class="n">y</span> <span class="n">gnupg2</span> <span class="p">&amp;&amp;</span> <span class="n">apt</span><span class="p">-</span><span class="n">get</span> <span class="n">install</span> <span class="p">-</span><span class="n">y</span> <span class="n">wget</span>

<span class="nc">RUN</span> <span class="n">wget</span> <span class="p">-</span><span class="n">q</span> <span class="p">-</span><span class="nc">O</span> <span class="p">-</span> <span class="n">https</span><span class="o">://</span><span class="n">dl</span><span class="p">-</span><span class="n">ssl</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">linux_signing_key</span><span class="p">.</span><span class="n">pub</span> <span class="p">|</span> <span class="n">apt</span><span class="p">-</span><span class="n">key</span> <span class="n">add</span> <span class="p">-</span> <span class="err">\</span>
      <span class="p">&amp;&amp;</span> <span class="n">sh</span> <span class="p">-</span><span class="n">c</span> <span class="k">'</span><span class="n">echo</span> <span class="s2">"deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main"</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="kt">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">google</span><span class="p">.</span><span class="n">list'</span> <span class="err">\</span>
      <span class="p">&amp;&amp;</span> <span class="n">apt</span><span class="p">-</span><span class="n">get</span> <span class="n">update</span> <span class="err">\</span>
      <span class="p">&amp;&amp;</span> <span class="n">apt</span><span class="p">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">xvfb</span> <span class="n">unzip</span> <span class="n">google</span><span class="p">-</span><span class="n">chrome</span><span class="p">-</span><span class="n">stable</span> <span class="p">-</span><span class="n">y</span> <span class="err">\</span>
      <span class="p">&amp;&amp;</span> <span class="n">wget</span> <span class="n">https</span><span class="o">://</span><span class="n">chromedriver</span><span class="p">.</span><span class="n">storage</span><span class="p">.</span><span class="n">googleapis</span><span class="p">.</span><span class="n">com</span><span class="o">/$</span><span class="nc">CHROME_DRIVER_VERSION</span><span class="o">/</span><span class="n">chromedriver_linux64</span><span class="p">.</span><span class="n">zip</span> <span class="err">\</span>
      <span class="p">&amp;&amp;</span> <span class="n">unzip</span> <span class="p">-</span><span class="n">d</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span> <span class="n">chromedriver_linux64</span><span class="p">.</span><span class="n">zip</span></code></pre></figure>

<p>To summarize. In this article, I show how to combine two possibilities of scraping data from a webpage (if it doesn’t have an API). And also how to write a simple application that simply does something in Fable. I hope you enjoyed this article :)</p>

<p>Thanks!</p>

<p>Full repo <a href="https://github.com/MNie/Bailif.Auctions">here</a></p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Visualization+of+estates+on+a+map+with+Fable%20-%20http://mnie.me/estatesonmap%20by%20@mnie8" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://mnie.me/estatesonmap" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer scrollappear">
  <p>
    2020
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-81299349-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-81299349-1');
  </script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
