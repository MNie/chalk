<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MNie | Static typescript client for controller actions, is it possible?</title>
  <meta name="description" content="Thanks to a Typescript we have some opportunity to use some `strongly-typed` language on a front-end side. But still we have to somehow communicate with a server side. Model the response. Is it possible to do it automatically for use, so we could only add some npm package which would have all of the models there along with clients? Yes it is!">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Static typescript client for controller actions, is it possible?">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://mnie.me/statictypescriptclient">
  <meta property="og:description" content="Thanks to a Typescript we have some opportunity to use some `strongly-typed` language on a front-end side. But still we have to somehow communicate with a server side. Model the response. Is it possible to do it automatically for use, so we could only add some npm package which would have all of the models there along with clients? Yes it is!">
  <meta property="og:site_name" content="MNie">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://mnie.me/statictypescriptclient">
  <meta name="twitter:title" content="Static typescript client for controller actions, is it possible?">
  <meta name="twitter:description" content="Thanks to a Typescript we have some opportunity to use some `strongly-typed` language on a front-end side. But still we have to somehow communicate with a server side. Model the response. Is it possible to do it automatically for use, so we could only add some npm package which would have all of the models there along with clients? Yes it is!">

  
    
      <meta property="og:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
      <meta name="twitter:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
    
  

  <link href="http://mnie.me/feed.xml" type="application/rss+xml" rel="alternate" title="MNie Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-8d94e1b2ced7d843d882416da48ad6b7a0386071412905b6048dbe8205e32559.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-03c296a876e33d932966817b36fde1212bdb044fb0585145cde98ac98da59715.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-52a5e7e150abd939a150d09a93ec31ffd219b9e01c09465a899f36f3654beef1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="MNie">MNie</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/mnie8" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/mnie" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://stackoverflow.com/users/2947860" rel="noreferrer noopener" target="_blank" title="Stack Overflow">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-stackoverflow">
  <use href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow" xlink:href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/michał-niegrzybowski" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:michal.niegrzybowski@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>Static typescript client for controller actions, is it possible?</h1>
            <p>Thanks to a Typescript we have some opportunity to use some `strongly-typed` language on a front-end side. But still we have to somehow communicate with a server side. Model the response. Is it possible to do it automatically for use, so we could only add some npm package which would have all of the models there along with clients? Yes it is!</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    March 24, 2018
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      11 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/csharp" title="See all posts with tag 'C#'">C#</a>
    
      
      <a href="/tag/typescript" title="See all posts with tag 'TypeScript'">TypeScript</a>
    
      
      <a href="/tag/javascript" title="See all posts with tag 'JavaScript'">JavaScript</a>
    
      
      <a href="/tag/microservices" title="See all posts with tag 'Microservices'">Microservices</a>
    
      
      <a href="/tag/patterns" title="See all posts with tag 'Patterns'">Patterns</a>
    
      
      <a href="/tag/cleancode" title="See all posts with tag 'Clean Code'">Clean Code</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Hey,</p>

<p>recently I interest in a topic of generating a static typescript client directly from C# controllers code. I decided that it would be a nice idea to generate such agreement in the project, in which I am currently working. For this purpose, I decided I want to try the TypeWriter library to create the contract. However, it turns out that in the case of such contract, it requires some actions which would help in gathering return types and types of accepted parameters by controllers actions.</p>

<p>So I started with deleting all occurrences of a parameter(s) deserialization in actions, so the signature of a function would accept parameters of concrete types, cause at this point actions looks similar to this one:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">JsonResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">d</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">SomeType</span><span class="p">&gt;(</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">r</span> <span class="p">=</span> <span class="n">_someService</span><span class="p">.</span><span class="nf">DoSomething</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">Json</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">JsonResult</span><span class="p">.</span><span class="n">AllowGet</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>As we could see that accepted argument has a type of string. Which in fact hides a concrete type which is passed to an action. There were sometimes issues when we use concrete types instead of a string because passed objects are far more complicated than an object like this:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dede"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>This is because the default ASP.NET deserializer sometimes didn’t work correctly. So to define concrete types I have to use ModelBinder, which gives an ability to do something with coming parameters. In our case, deserializing them by Newtonsoft.Json library. The main advantage of using the ModelBinder is that the deserialization phase took place in one place instead of every action. Implementation of such ModelBinder looks like that:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">internal</span> <span class="k">class</span> <span class="nc">CustomModelBinder</span> <span class="p">:</span> <span class="n">IModelBinder</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_type</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">CustomModelBinder</span><span class="p">(</span><span class="n">Type</span> <span class="n">@type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_type</span> <span class="p">=</span> <span class="n">@type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">BindModel</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">c</span><span class="p">,</span> <span class="n">ModelBindingContext</span> <span class="n">mb</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="n">controllerContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">mb</span><span class="p">.</span><span class="n">ModelName</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">json</span> <span class="p">==</span> <span class="k">null</span>
            <span class="p">?</span> <span class="k">null</span>
            <span class="p">:</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">DeserializeObject</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">_type</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Of course, the implementation of ModelBinder is not enough. We have to “tell” somehow to the project, how to use this implementation. To achieve this we have to register Binder for concrete types in global.asax.cs file. Which we could do like that:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;</span> <span class="n">CustomBinderTypes</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span>
<span class="p">{</span>
    <span class="k">typeof</span><span class="p">(</span><span class="n">TypeA</span><span class="p">),</span>
    <span class="k">typeof</span><span class="p">(</span><span class="n">TypeB</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="err">…</span>
    <span class="n">CustomBinderTypes</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">ModelBinders</span><span class="p">.</span><span class="n">Binders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">new</span> <span class="nf">CustomModelBinder</span><span class="p">(</span><span class="n">t</span><span class="p">)));</span>
    <span class="err">…</span>
<span class="p">}</span></code></pre></figure>

<p>Thanks to above, the signature of function could evolve to the following:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">JsonResult</span> <span class="nf">Get</span><span class="p">(</span><span class="n">SomeData</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span><span class="err">…</span><span class="p">}</span></code></pre></figure>

<p>At this moment I would know exactly what types are required by controller action parameters in a static client. But because I decided to create a static client, I also need an information about return types. When actions are defined like that they return JsonResult or ActionResult, the return type is boxed and this is not what we expect. So to return the concrete type from each action I have to implement an ActionInvoker, which has a job to do something right after the body of actions. Thanks to which the signature of an action would tell us what concrete type would be returned. But in fact somewhere below (in ActionInvoker) this value would be boxed into ActionResult or JsonResult.</p>

<p>Implementation of ActionInvoker looks like that:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">WebApiInvoker</span> <span class="p">:</span> <span class="n">AsyncControllerActionInvoker</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">ActionResult</span> <span class="nf">CreateActionResult</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">c</span><span class="p">,</span> <span class="n">ActionDescriptor</span> <span class="n">a</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">@type</span> <span class="p">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">as</span> <span class="n">ReflectedActionDescriptor</span><span class="p">)?.</span><span class="n">MethodInfo</span><span class="p">?.</span><span class="n">ReturnType</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ActionResult</span><span class="p">).</span><span class="nf">IsAssignableFrom</span><span class="p">(</span><span class="n">@type</span><span class="p">)</span>
            <span class="p">?</span> <span class="k">base</span><span class="p">.</span><span class="nf">CreateActionResult</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>
            <span class="p">:</span> <span class="k">new</span> <span class="nf">JsonResult</span><span class="p">(){</span><span class="n">data</span> <span class="p">=</span> <span class="k">value</span><span class="p">,</span> <span class="err">…</span><span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Similar to the Binder, we have to tell somehow, how to use Invoker. We could achieve that in few ways. Use it in controller constructor in which we want to use it or set it in a controller factory which is responsible for creating them.</p>

<p>In concrete controller:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">SomeController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SomeController</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ActionInvoker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebApiInvoker</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In controller factory:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">internal</span> <span class="k">class</span> <span class="nc">ServiceLocatorControllerFactory</span> <span class="p">:</span> <span class="n">DefaultControllerFactory</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">IController</span> <span class="nf">GetControllerInstance</span><span class="p">(</span><span class="n">RequestContext</span> <span class="n">r</span><span class="p">,</span> <span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">con</span> <span class="p">=</span> <span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="n">ServiceLocator</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="n">con</span><span class="p">.</span><span class="n">ActionInvoker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebApiInvoker</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">con</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Because ActionInvoker has been used for all controllers, there is a possibility, that someone still wants to return ActionResult or JsonResult for some reason. What if someone creates a function which has a return type of ActionResult od JsonResult and returns null inside of it? What is the expected behavior for this type of return types? The expected behavior is different, in case of ActionResult, the new EmptyResult should be returned in case of JSON a null as a JSON. So when we look at the implementation of WebApiInvoker right now it seems to be invalid, cause when we return null it will return a null as a JsonResult what could cause such errors:</p>

<p><img src="https://mnie.github.com/img/24-03-2018StaticClient/image.png" alt="img" /></p>

<p>So if we want to avoid such errors we have to check what type is expected to be returned. How could we achieve that? By reflection? Of course, but we could do it slightly easier, what could be seen here:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">protected</span> <span class="k">override</span> <span class="n">ActionResult</span> <span class="nf">CreateActionResult</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">c</span><span class="p">,</span> <span class="n">ActionDescriptor</span> <span class="n">a</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">@type</span> <span class="p">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">as</span> <span class="n">ReflectedActionDescriptor</span><span class="p">)?.</span><span class="n">MethodInfo</span><span class="p">?.</span><span class="n">ReturnType</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ActionResult</span><span class="p">).</span><span class="nf">IsAssignableFrom</span><span class="p">(</span><span class="n">@type</span><span class="p">)</span>
        <span class="p">?</span> <span class="k">base</span><span class="p">.</span><span class="nf">CreateActionResult</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">new</span> <span class="nf">JsonResult</span><span class="p">(){</span><span class="n">data</span> <span class="p">=</span> <span class="k">value</span> <span class="err">…</span><span class="p">};</span>
<span class="p">}</span></code></pre></figure>

<p>We could see here that thanks to code like that, we handle all cases and the code is still clear and readable, cause in comparison to the first result, the corrected solution contains only a check what return type is expected.</p>

<p>At this moment I was ready to generate a contract. To achieve that goal I use a TypeWriter library and I based on a basic template.</p>

<p>You could install TypeWriter as a NuGet package like that:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Install-Package</span><span class="w"> </span><span class="nx">TypeWriter</span></code></pre></figure>

<p>TypeWriter templates are located in .tst files. Below is a basic template to generate a contract for actions from controllers.</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">$</span><span class="p">{</span>
    <span class="nx">using</span> <span class="nx">Typewriter</span><span class="p">.</span><span class="nx">Extensions</span><span class="p">.</span><span class="nx">WebApi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">CallService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../core/core.module</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">module</span> <span class="nx">App</span> <span class="p">{</span> <span class="nx">$Classes</span><span class="p">(:</span><span class="nx">Controller</span><span class="p">)[</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">$Name</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">CallService</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span> <span class="nx">$Methods</span><span class="p">[</span>

        <span class="kr">public</span> <span class="nx">$name</span> <span class="o">=</span> <span class="p">(</span><span class="nx">$Parameters</span><span class="p">[</span><span class="nx">$name</span><span class="p">:</span> <span class="nx">$Type</span><span class="p">][,</span> <span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">$HttpMethod</span><span class="p">(</span><span class="s2">`$Url`</span><span class="p">,</span> <span class="nx">$RequestData</span><span class="p">);</span>
        <span class="p">}]</span>
    <span class="p">}]</span>
<span class="p">}</span></code></pre></figure>

<p>This code should be located in our web project.</p>

<p>After saving a template file. The contract should be generated and all .ts files should be attached to the template (.tst file). When we look at the generated files, we could notice a couple of things that need improvement. The first one is that this template generates a contract for all controllers. This behavior is not intentional in my case because some of the controllers are not called from a typescript code. So I want to generate contract only for files located in namespace <em>.Public.</em>.</p>

<p>This issue could be fixed by code like that:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">module</span> <span class="nx">App</span> <span class="p">{</span> <span class="nx">$Classes</span><span class="p">(</span><span class="o">*</span><span class="p">.</span><span class="nx">Public</span><span class="p">.</span><span class="o">*</span><span class="nx">Controller</span><span class="p">)[</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">$Name</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">CallService</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span> <span class="nx">$Methods</span><span class="p">[</span>

        <span class="kr">public</span> <span class="nx">$name</span> <span class="o">=</span> <span class="p">(</span><span class="nx">$Parameters</span><span class="p">[</span><span class="nx">$name</span><span class="p">:</span> <span class="nx">$Type</span><span class="p">][,</span> <span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">$HttpMethod</span><span class="p">(</span><span class="s2">`$Url`</span><span class="p">,</span> <span class="nx">$RequestData</span><span class="p">);</span>
        <span class="p">}]</span>
    <span class="p">}]</span>
<span class="p">}</span></code></pre></figure>

<p>After a while, I noticed that I would like to exclude some specific controllers from the generation. For this purpose, I wrote a function which should be located in curly braces. This piece of code is not a rocket science, its only check if the namespace of a controller starts with <em>.Public.</em> and if the file is not this one which should be excluded from generation.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="err">$</span><span class="p">{</span>
    <span class="k">using</span> <span class="nn">Typewriter.Extensions.WebApi</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">NotIncluedeControllers</span> <span class="p">=</span> <span class="k">new</span> <span class="p">[]{</span><span class="s">"Export"</span><span class="p">,</span> <span class="s">"Diagnostics"</span><span class="p">,</span> <span class="s">"Download"</span><span class="p">};</span>

    <span class="kt">bool</span> <span class="nf">ShouldScanController</span><span class="p">(</span><span class="n">Class</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">FullName</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="s">"App.Web.Controllers.Public"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span>
        <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">NotIncluedeControllers</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Invocation of this method looks like this:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">module</span> <span class="nx">App</span> <span class="p">{</span> <span class="nx">$Classes</span><span class="p">(</span><span class="nx">$ShouldScanController</span><span class="p">)[</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">$Name</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">CallService</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span> <span class="nx">$Methods</span><span class="p">[</span>

        <span class="kr">public</span> <span class="nx">$name</span> <span class="o">=</span> <span class="p">(</span><span class="nx">$Parameters</span><span class="p">[</span><span class="nx">$name</span><span class="p">:</span> <span class="nx">$Type</span><span class="p">][,</span> <span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">$methodType</span><span class="p">(</span><span class="s2">`$Url`</span><span class="p">,</span> <span class="nx">$RequestData</span><span class="p">);</span>
        <span class="p">}]</span>
    <span class="p">}]</span>
<span class="p">}</span></code></pre></figure>

<p>Next thing is that methods in C# code sometimes have the same names, but they differ in parameters and route, it is okay for C# code, but typescript code where a class contains methods with the same names wouldn’t compile. So because of that, I decided that methods in typescript contract should have names corresponding to the last part of a route. To generate such names, we need to write a function like that:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">string</span> <span class="nf">NameFromRoute</span><span class="p">(</span><span class="n">Method</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">.</span><span class="nf">Route</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span><span class="s">"/"</span><span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Last</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>And use it in the template like that:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">$Classes</span><span class="p">(</span><span class="nx">$ShouldScanController</span><span class="p">)[</span><span class="nx">$ImportStatements</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">$Name</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">CallService</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span> <span class="nx">$Methods</span><span class="p">[</span>

    <span class="kr">public</span> <span class="nx">$NameFromRoute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">$Parameters</span><span class="p">[</span><span class="nx">$name</span><span class="p">:</span> <span class="nx">$Type</span><span class="p">][,</span> <span class="p">]):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">$Type</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">$MethodType</span><span class="p">(</span><span class="s2">`$Url`</span><span class="p">,</span> <span class="nx">$RequestData</span><span class="p">);</span>
    <span class="p">}]</span>
<span class="p">}]</span></code></pre></figure>

<p>We could see, that everything should work fine until someone defines a route like that <code class="highlighter-rouge">/get/{userId}</code>. We rather do not want to have a function with name <code class="highlighter-rouge">{userId}</code>. So to easily go around such problems, for such actions the name of typescript function will match C# method name, the fixed code looks like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">string</span> <span class="nf">NameFromRoute</span><span class="p">(</span><span class="n">Method</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">lastRoute</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">Route</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span><span class="s">"/"</span><span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Last</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lastRoute</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"{"</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">m</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">lastRoute</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Another thing that should be fixed is getting the type of an action, when it is defined via several HttpVerbs options, the generated method looks like that:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">verbs</span><span class="p">.</span><span class="kd">get</span> <span class="nx">system</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">verbs</span><span class="p">.</span><span class="nx">post</span></code></pre></figure>

<p>It was not exactly what I expected, therefore I wrote a very simple code which, when method accepts verbs instead of concrete HttpType it should return the last specified verb (since in case of my project if method contains a couple of verbs it is always a get and then post and from a typescript code we use only a post one)</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">string</span> <span class="nf">MethodType</span><span class="p">(</span><span class="n">Method</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">.</span><span class="nf">HttpMethod</span><span class="p">().</span><span class="nf">Split</span><span class="p">(</span><span class="sc">' '</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'.'</span><span class="p">).</span><span class="nf">Last</span><span class="p">()).</span><span class="nf">Last</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>The next thing which I spot is a strange way of gathering an action type. For a method which looks like that:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="err">„</span><span class="n">delete</span><span class="err">”</span><span class="p">)]</span>
<span class="k">public</span> <span class="kt">bool</span> <span class="nf">Delete</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span><span class="err">…</span><span class="p">}</span></code></pre></figure>

<p>The type of HttpMethod has not been set as HttpGet but as a HttpDelete (the question is why Delete function is a HttpGet ;)?). Of course, this is a bug in a code, but the behavior of generator is weird. It is a possibility that there is also some bug in TypeWriter library, although a solution to that problem was to set a proper Http type to an action in C# code (in my case HttpPost…).</p>

<p>The last thing which we need is to add all necessary imports at the top of each generated file. To do that I have to write a function which scans all return types, accepted parameters types, generic types and for all of them generates import statements. In our case it is a little bit simplified because a contract for classes/enums is generated via another .tst file, so they are located in one place/folder. Thanks to that construction of import statement are pretty straightforward and the whole method looks like that:</p>

<script src="https://gist.github.com/MNie/edcdf5b9b8fa9281400752627cff64ae.js"></script>

<p>And finally a full template looks like that:</p>

<script src="https://gist.github.com/MNie/ba0cdc9ab7423dcd29881c2da04aeb11.js"></script>

<p>Summarizing, thanks to the above steps, controllers in our code base are much more clear and readable and don’t contain unnecessary things like explicit deserialization. Also, we are able to generate a static contract for typescript code, so we could avoid hardcoding paths to actions in typescript code.</p>

<p>Thank you for reading :)</p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Static+typescript+client+for+controller+actions,+is+it+possible?%20-%20http://mnie.me/statictypescriptclient%20by%20@mnie8" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://mnie.me/statictypescriptclient" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer scrollappear">
  <p>
    2020
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-81299349-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-81299349-1');
  </script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
